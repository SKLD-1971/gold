<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Center</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        :root {
            --staff-color: #FFD700;
            --support-color: #7289DA;
            --promoter-color: #ff4081;
            --danger-color: #e74c3c;
            --danger-glow: rgba(231, 76, 60, 0.4);
            
            /* --- Snow Theme --- */
            --background-start: #0d1a2f;
            --background-end: #040a18;
            --surface-color: rgba(10, 20, 40, 0.65);
            --primary-color: #89b4fa; /* A cool, icy blue */
            --glow-color: rgba(137, 180, 250, 0.5);
            --text-primary: #cdd6f4;
            --text-secondary: #a6adc8;
            --border-color: rgba(137, 180, 250, 0.2);
            --input-bg: rgba(5, 10, 25, 0.7);
            --container-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 25px var(--glow-color);
            --border-radius: 16px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(to bottom, var(--background-start), var(--background-end));
            color: var(--text-primary);
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            margin: 0; padding: 20px; overflow: hidden; position: relative;
        }
        
        /* Snow Animation */
        #snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .snowflake { position: absolute; background: white; border-radius: 50%; opacity: 0.8; }
        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0vw); }
            100% { transform: translateY(110vh) translateX(5vw); }
        }

        .container {
            background: var(--surface-color); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 40px;
            width: 100%; max-width: 800px; box-shadow: var(--container-shadow); z-index: 1;
            max-height: 90vh; overflow-y: auto; transition: all 0.5s ease;
        }
        
        .page-section { display: none; } .page-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .logo-container { text-align: center; margin-bottom: 20px; }
        .logo-container img { max-width: 150px; border-radius: 50%; filter: drop-shadow(0 0 15px var(--glow-color)); }
        
        #selection-page .subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 30px; font-size: 1.1em; }
        .selection-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        
        .selection-card { display: flex; align-items: center; gap: 20px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s ease; }
        .selection-card:hover { transform: translateY(-5px); border-color: var(--primary-color); box-shadow: 0 5px 20px rgba(137, 180, 250, 0.3); }
        .selection-card .icon { flex-shrink: 0; width: 40px; height: 40px; display:flex; justify-content:center; align-items:center; }
        .selection-card h2 { margin: 0 0 5px 0; color: var(--text-primary); } .selection-card p { margin: 0; color: var(--text-secondary); }

        label { display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-secondary); }
        textarea, input, select { width: 100%; padding: 14px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; color: var(--text-primary); box-sizing: border-box; transition: all 0.3s ease; }
        textarea:focus, input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 15px var(--glow-color); }
        select { appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 1rem center; background-size: .8em; padding-right: 2.5rem; }
        .form-header, .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .form-header h1, .page-header h1 { margin: 0; text-align: left; font-size: 2em; color: var(--primary-color); text-shadow: 0 0 10px var(--glow-color); }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 16px; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-size: 1.1em; font-weight: 700; transition: all 0.3s ease; }
        .btn-primary { background: var(--primary-color); color: var(--background-start); box-shadow: 0 0 20px var(--glow-color); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 5px 25px var(--glow-color); }
        .btn-secondary { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 8px 16px; font-size: 0.9em; width: auto; }
        
        .fixed-buttons-container { position: fixed; z-index: 1001; }
        .top-right { top: 20px; right: 20px; }
        .bottom-right { bottom: 20px; right: 20px; }
        .fixed-btn { background: var(--surface-color); border: 1px solid var(--border-color); width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); backdrop-filter: blur(10px); transition: all 0.3s ease; color: var(--text-primary); }
        .fixed-btn:hover { border-color: var(--primary-color); transform: scale(1.1); }

        /* Admin Panel & Webhook Editor Styles */
        #admin-panel { padding: 0; border: none; }
        .admin-layout, .webhook-editor-layout { display: flex; gap: 20px; min-height: 500px; }
        .admin-sidebar { width: 220px; flex-shrink: 0; }
        .admin-nav-btn { display: block; width: 100%; text-align: left; background: none; border: none; color: var(--text-secondary); padding: 10px; border-radius: 6px; cursor: pointer; font-size: 1em; margin-bottom: 5px; }
        .admin-nav-btn:hover, .admin-nav-btn.active { background: var(--primary-color); color: var(--background-start); }
        .admin-content { flex-grow: 1; max-height: 65vh; overflow-y: auto;}
        .admin-section { display: none; } .admin-section.active { display: block; }
        .btn-danger { background: rgba(231, 76, 60, 0.2); color: var(--danger-color); border: 1px solid var(--danger-color); }
        .btn-danger:hover { box-shadow: 0 0 15px var(--danger-glow); }
        
        /* Webhook Editor Tabs */
        .webhook-editor-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .webhook-tab { padding: 10px 15px; background: none; border: none; color: var(--text-secondary); cursor: pointer; border-radius: 6px 6px 0 0; }
        .webhook-tab.active { background: var(--surface-color); border: 1px solid var(--border-color); border-bottom: 1px solid var(--surface-color); color: var(--primary-color); }
        .webhook-editor-pane { display: none; } .webhook-editor-pane.active { display: block; }

        /* Discord Preview Styles */
        .discord-preview-container { width: 350px; flex-shrink: 0; background-color: #36393f; border-radius: 8px; padding: 16px; }
        #preview-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #7289da; }
        #preview-username { font-weight: 600; color: #fff; }
        .discord-embed { background-color: #2f3136; border-radius: 4px; border-left: 4px solid; padding: 12px; }
        #preview-embed-title { color: #fff; font-weight: 700; margin: 0 0 8px 0; }
        .discord-embed-field strong { color: #b9bbbe; font-size: 0.9em; }
        .discord-embed-field p { color: #dcddde; margin: 0; background: #202225; padding: 4px; border-radius: 3px; }

        /* Application Editor specific styles */
        .editor-question-item { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        .editor-question-item input { flex-grow: 1; }
        .editor-question-item select { width: 120px; flex-shrink: 0; }
        .editor-question-item .btn-danger { width: 40px; height: 40px; padding: 0; font-size: 1.2em; flex-shrink: 0; }
        #editor-selection-buttons { display: flex; flex-direction: column; gap: 10px; }

    </style>
</head>
<body>
    <div id="snow-container"></div>
    
    <div class="fixed-buttons-container top-right">
        <div class="fixed-btn" onclick="showPage('login-page')" title="Admin Login">
            <svg fill="currentColor" viewBox="0 0 20 20" width="24"><path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 12a1 1 0 100-2 1 1 0 000 2z"></path></svg>
        </div>
    </div>
    <div class="fixed-buttons-container bottom-right">
        <a href="https://discord.gg/42AjuqEDZs" target="_blank" class="fixed-btn" title="Join our Discord">
            <svg width="28" height="28" viewBox="0 0 245 195" fill="currentColor"><path d="M207.3,0.0 C207.3,0.0 200.3,3.3 194.3,9.0 C182.2,4.2 169.4,1.4 156.4,0.3 C156.1,0.3 155.7,0.4 155.4,0.5 C147.9,2.5 141.2,5.5 135.2,9.0 C117.8,4.7 99.8,4.7 82.5,9.0 C76.5,5.5 69.8,2.5 62.3,0.5 C62.0,0.4 61.6,0.3 61.3,0.3 C48.3,1.4 35.5,4.2 23.4,9.0 C17.4,3.3 10.4,0.0 10.4,0.0 C10.4,0.0 -3.4,22.0 0.4,65.2 C15.9,78.2 31.0,86.4 46.1,92.5 C45.9,93.4 45.7,94.3 45.6,95.1 C41.9,94.9 38.3,94.4 34.8,93.5 C34.5,93.4 34.2,93.5 34.0,93.7 C30.0,95.5 26.3,97.7 22.9,100.3 C22.7,100.4 22.6,100.6 22.6,100.9 C29.4,122.3 41.5,139.7 57.5,152.0 C57.7,152.2 58.0,152.3 58.3,152.2 C64.8,150.0 70.9,147.4 76.6,144.4 C76.9,144.2 77.1,143.9 77.0,143.6 C75.9,141.1 74.9,138.6 74.0,136.0 C73.9,135.8 73.6,135.7 73.4,135.8 C70.0,137.2 66.5,138.5 62.9,139.6 C62.6,139.7 62.3,139.6 62.1,139.3 C42.3,123.9 29.3,101.5 24.0,76.5 C24.0,76.5 24.1,76.5 24.1,76.5 C28.0,74.9 31.8,73.4 35.4,72.0 C35.7,71.9 36.0,72.0 36.1,72.3 C37.8,76.4 39.8,80.4 42.1,84.1 C42.2,84.4 42.5,84.5 42.8,84.4 C73.9,73.2 100.8,73.2 127.8,84.4 C128.1,84.5 128.4,84.4 128.5,84.1 C130.8,80.4 132.8,76.4 134.5,72.3 C134.6,72.0 134.9,71.9 135.2,72.0 C138.8,73.4 142.6,74.9 146.5,76.5 C146.5,76.5 146.6,76.5 146.6,76.5 C141.3,101.5 128.3,123.9 108.5,139.3 C108.3,139.6 108.0,139.7 107.7,139.6 C104.1,138.5 100.6,137.2 97.2,135.8 C96.9,135.7 96.7,135.8 96.6,136.0 C95.7,138.6 94.7,141.1 93.6,143.6 C93.5,143.9 93.7,144.2 94.0,144.4 C99.7,147.4 105.8,150.0 112.3,152.2 C112.6,152.3 112.9,152.2 113.1,152.0 C129.1,139.7 141.2,122.3 148.0,100.9 C148.0,100.6 147.9,100.4 147.7,100.3 C144.3,97.7 140.6,95.5 136.6,93.7 C136.4,93.5 136.1,93.4 135.8,93.5 C132.3,94.4 128.7,94.9 125.0,95.1 C124.9,94.3 124.7,93.4 124.5,92.5 C139.6,86.4 154.7,78.2 170.2,65.2 C174.0,22.0 161.2,0.0 161.2,0.0 C161.2,0.0 168.2,3.3 174.2,9.0 C186.3,4.2 199.1,1.4 212.1,0.3 C212.4,0.3 212.8,0.4 213.1,0.5 C220.6,2.5 227.3,5.5 233.3,9.0 C245.4,4.7 263.4,4.7 280.7,9.0 C286.7,5.5 293.4,2.5 300.9,0.5 C301.2,0.4 301.6,0.3 301.9,0.3 C314.9,1.4 327.7,4.2 339.8,9.0 C345.8,3.3 352.8,0.0 352.8,0.0 C352.8,0.0 366.6,22.0 362.8,65.2 C347.3,78.2 332.2,86.4 317.1,92.5 C317.3,93.4 317.5,94.3 317.6,95.1 C321.3,94.9 324.9,94.4 328.4,93.5 C328.7,93.4 329.0,93.5 329.2,93.7 C333.2,95.5 336.9,97.7 340.3,100.3 C340.5,100.4 340.6,100.6 340.6,100.9 C333.8,122.3 321.7,139.7 305.7,152.0 C305.5,152.2 305.2,152.3 304.9,152.2 C298.4,150.0 292.3,147.4 286.6,144.4 C286.3,144.2 286.1,143.9 286.2,143.6 C287.3,141.1 288.3,138.6 289.2,136.0 C289.3,135.8 289.6,135.7 289.8,135.8 C293.2,137.2 296.7,138.5 300.3,139.6 C300.6,139.7 300.9,139.6 301.1,139.3 C320.9,123.9 333.9,101.5 339.2,76.5 C339.2,76.5 339.1,76.5 339.1,76.5 C335.2,74.9 331.4,73.4 327.8,72.0 C327.5,71.9 327.2,72.0 327.1,72.3 C325.4,76.4 323.4,80.4 321.1,84.1 C321.0,84.4 320.7,84.5 320.4,84.4 C289.3,73.2 262.4,73.2 235.4,84.4 C235.1,84.5 234.8,84.4 234.7,84.1 C232.4,80.4 230.4,76.4 228.7,72.3 C228.6,72.0 228.3,71.9 228.0,72.0 C224.4,73.4 220.6,74.9 216.7,76.5 C216.7,76.5 216.6,76.5 216.6,76.5 C221.9,101.5 234.9,123.9 254.7,139.3 C254.9,139.6 255.2,139.7 255.5,139.6 C259.1,138.5 262.6,137.2 266.0,135.8 C266.3,135.7 266.5,135.8 266.6,136.0 C267.5,138.6 268.5,141.1 269.6,143.6 C269.7,143.9 269.5,144.2 269.2,144.4 C263.5,147.4 257.4,150.0 250.9,152.2 C250.6,152.3 250.3,152.2 250.1,152.0 C234.1,139.7 222.0,122.3 215.2,100.9 C215.2,100.6 215.3,100.4 215.5,100.3 C218.9,97.7 222.6,95.5 226.6,93.7 C226.8,93.5 227.1,93.4 227.4,93.5 C230.9,94.4 234.5,94.9 238.2,95.1 C238.3,94.3 238.5,93.4 238.7,92.5 C223.6,86.4 208.5,78.2 193.0,65.2 C189.2,22.0 202.0,0.0 202.0,0.0 L207.3,0.0 Z"></path></svg>
        </a>
    </div>

    <div class="container">
        <!-- Main Pages (Login, Selection) -->
        <div id="selection-page" class="page-section active">
            <div class="logo-container"><img src="https://media.discordapp.net/attachments/1210718340449042473/1438107990074069052/Goldsnow.png" alt="Logo"></div>
            <p class="subtitle">Select the path you wish to apply for, traveler.</p>
            <div class="selection-grid"></div>
        </div>
        
        <div id="login-page" class="page-section">
            <div class="page-header"><h1>Developer Sanctum</h1><button class="btn btn-secondary" onclick="showSelection()">Back</button></div>
            <div class="input-group" style="margin-bottom: 1rem;"><input type="text" id="login-user" placeholder="Enter username"></div>
            <div class="input-group" style="margin-bottom: 1rem;"><input type="password" id="login-pass" placeholder="Enter password"></div>
            <button class="btn btn-primary" onclick="handleDevLogin()">Login</button>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="page-section">
            <div class="page-header"><h1>Admin Panel</h1><button class="btn btn-secondary" onclick="showSelection()">Logout</button></div>
            <div class="admin-layout">
                <div class="admin-sidebar">
                    <h3>Management</h3>
                    <button class="admin-nav-btn active" data-target="admin-webhooks">Webhook Editor</button>
                    <button class="admin-nav-btn" data-target="admin-editor">Application Editor</button>
                    <div style="margin-top: auto;"><button class="btn btn-danger" onclick="resetAllData()">Reset All Settings</button></div>
                </div>
                <div class="admin-content">
                    <!-- Webhook Editor Section -->
                    <div id="admin-webhooks" class="admin-section active">
                        <div class="webhook-editor-layout">
                           <div class="webhook-editor-controls" style="flex: 1;">
                               <div class="webhook-editor-tabs"></div>
                               <div id="webhook-editor-container"></div>
                               <button class="btn btn-primary" onclick="saveAllSettings()" style="margin-top: 20px;">Save All Settings</button>
                           </div>
                           <div class="discord-preview-container">
                                <h3>Live Preview</h3>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <img id="preview-avatar" src="">
                                    <span id="preview-username">Application Bot</span>
                                </div>
                                <div class="discord-embed" id="preview-embed">
                                    <h4 id="preview-embed-title">New Staff Application</h4>
                                    <div class="discord-embed-field"><strong>Your Discord ID & Tag</strong><p>user#0001</p></div>
                                </div>
                           </div>
                        </div>
                    </div>
                    <!-- Application Question Editor -->
                    <div id="admin-editor" class="admin-section">
                        <h2>Application Editor</h2>
                        <div id="editor-selection-buttons"></div>
                        <div id="application-editor-view" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="form-container" class="page-section"></div>
    </div>
    
    <script>
    // --- Central Data Store & Defaults ---
    let siteSettings;

    const defaultSettings = {
        logWebhooks: { visitUrl: "", adminLogUrl: "" },
        appConfigs: {
            support: { 
                webhookUrl: "", username: "Support Bot", avatarUrl: "https://media.discordapp.net/attachments/1210718340449042473/1438107990074069052/Goldsnow.png", embedColor: "#7289DA", embedTitle: "New {role} Application", 
                title: "Support", icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="40"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`, color: "var(--support-color)", 
                desc: "Handle player issues, questions, and conflicts.", 
                questions: [
                    { label: "How will you handle a situation where a player got scammed?", type: "textarea" },
                    { label: "What will you do if you see another staff member abuse by banning users randomly and being straight up toxic?", type: "textarea" },
                    { label: "What kind of proof will you accept if a victim provides you it?", type: "textarea" },
                    { label: "What do you do if you notice a moderator abusing his/hers title?", type: "textarea" },
                    { label: "What do you do if you see someone abusing bug to get free items?", type: "textarea" },
                    { label: "How active can you be per day?", type: "text" },
                    { label: "What will you do if you saw higher rank member abusing their power?", type: "textarea" }
                ] 
            },
            staff: { 
                webhookUrl: "", username: "Staff Bot", avatarUrl: "https://media.discordapp.net/attachments/1210718340449042473/1438107990074069052/Goldsnow.png", embedColor: "#FFD700", embedTitle: "New {role} Application", 
                title: "Staff", icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="40"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>`, color: "var(--staff-color)", 
                desc: "Enforce rules, moderate, and manage events.", 
                questions: [
                    { label: "How will you handle a situation where a player got scammed?", type: "textarea" },
                    { label: "What will you do if you see another staff member abuse by banning users randomly and being straight up toxic?", type: "textarea" },
                    { label: "What will you do if a person suffered from a rollback?", type: "textarea" },
                    { label: "What kind of proof will you accept if a victim provides you it?", type: "textarea" },
                    { label: "What do you do if you notice a moderator abusing his/hers title?", type: "textarea" },
                    { label: "What do you do if you see someone abusing bug to get free items?", type: "textarea" },
                    { label: "How active can you be per day?", type: "text" },
                    { label: "What will you do if you saw higher rank member abusing their power?", type: "textarea" }
                ] 
            },
            promoter: { 
                webhookUrl: "", username: "Promoter Bot", avatarUrl: "https://media.discordapp.net/attachments/1210718340449042473/1438107990074069052/Goldsnow.png", embedColor: "#ff4081", embedTitle: "New {role} Application", 
                title: "YouTuber / Promoter", icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="40"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`, color: "var(--promoter-color)", 
                desc: "Create content and build hype for the server.", 
                questions: [
                    { label: "Discord ID (user#0001)", type: "text" },
                    { label: "Link to your primary content channel (YouTube, Twitch, etc.).", type: "text" },
                    { label: "What is your average viewership or engagement per video/stream?", type: "text" },
                    { label: "Describe the type of content you plan to create for our server.", type: "textarea" },
                    { label: "What makes you a good fit for our community's brand?", type: "textarea" }
                ] 
            }
        }
    };

    function loadDataFromStorage() {
        const savedSettings = localStorage.getItem('gtpsAppSettingsV2');
        siteSettings = savedSettings ? JSON.parse(savedSettings) : JSON.parse(JSON.stringify(defaultSettings));
        Object.keys(siteSettings.appConfigs).forEach(key => {
            if (!siteSettings.appConfigs[key].questions) siteSettings.appConfigs[key].questions = [];
            siteSettings.appConfigs[key].questions.forEach((q, index) => {
                q.id = `${key.substring(0,3)}-q${index}`;
            });
        });
    }

    // --- Page Navigation & Core UI ---
    function showPage(pageId) { document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); }
    function showForm(formType) { showPage('form-container'); renderForm(formType); }
    function showSelection() { showPage('selection-page'); setupHomepage(); }
    
    function handleDevLogin() {
        if (document.getElementById('login-user').value === 'Gold' && document.getElementById('login-pass').value === 'gold98123') { 
            showPage('admin-panel'); 
            setupAdminPanel();
        } else { alert('Incorrect credentials.'); }
    }

    // --- Webhook & Submission Logic ---
    async function simpleWebhookSend(url, embed) {
        if (!url || !url.startsWith('https://discord.com/api/webhooks/')) return;
        try { await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(embed) });
        } catch (error) { console.error("Webhook send failed:", error); }
    }
    
    async function fetchGeoInfoAndLog() { /* ... unchanged ... */ }

    async function submitApplication(formType) {
        const config = siteSettings.appConfigs[formType];
        if (!config.webhookUrl) { alert('Admin error: Submission webhook is not configured for this role.'); return; }
        const fields = config.questions.map(q => ({ name: q.label, value: "```" + document.getElementById(q.id).value + "```", inline: false }));
        const payload = {
            username: config.username,
            avatar_url: config.avatarUrl,
            embeds: [{
                title: config.embedTitle.replace('{role}', config.title),
                color: parseInt(config.embedColor.substring(1), 16),
                fields: fields,
                timestamp: new Date().toISOString()
            }]
        };
        await simpleWebhookSend(config.webhookUrl, payload);
        alert('Success! Your application has been submitted.');
        showSelection();
    }
    
    // --- UI Rendering ---
    function setupHomepage() {
        const grid = document.querySelector('#selection-page .selection-grid');
        grid.innerHTML = '';
        for (const key in siteSettings.appConfigs) {
            const app = siteSettings.appConfigs[key];
            grid.innerHTML += `<div class="selection-card" onclick="showForm('${key}')"><div class="icon" style="color: ${app.color}">${app.icon}</div><div><h2>${app.title}</h2><p>${app.desc}</p></div></div>`;
        }
    }

    function renderForm(formType) {
        const data = siteSettings.appConfigs[formType];
        let formHTML = `<div class="form-header"><h1>${data.title} Application</h1><button class="btn btn-secondary" onclick="showSelection()">Back</button></div><form id="app-form">`;
        data.questions.forEach(q => {
            formHTML += `<div class="question-group" style="margin-bottom: 1rem;"><label for="${q.id}">${q.label}</label>`;
            formHTML += (q.type === 'textarea') ? `<textarea id="${q.id}" rows="5" required></textarea>` : `<input type="text" id="${q.id}" required>`;
            formHTML += `</div>`;
        });
        formHTML += `<button type="submit" class="btn btn-primary">Submit ${data.title} Application</button></form>`;
        document.getElementById('form-container').innerHTML = formHTML;
        document.getElementById('app-form').addEventListener('submit', (e) => { e.preventDefault(); submitApplication(formType); });
    }

    // --- Admin Panel ---
    function setupAdminPanel() {
        renderAdminNav();
        renderWebhookEditor(Object.keys(siteSettings.appConfigs)[0] || 'logs');
        setupApplicationEditorList();
    }
    
    function renderAdminNav() {
        document.querySelectorAll('.admin-nav-btn').forEach(btn => btn.addEventListener('click', (e) => {
            document.querySelectorAll('.admin-nav-btn, .admin-section').forEach(el => el.classList.remove('active'));
            e.currentTarget.classList.add('active');
            document.getElementById(e.currentTarget.dataset.target).classList.add('active');
        }));
    }

    function renderWebhookEditor(tabKey) {
        // Render tabs
        const tabsContainer = document.querySelector('.webhook-editor-tabs');
        tabsContainer.innerHTML = '';
        Object.keys(siteSettings.appConfigs).forEach(key => {
            tabsContainer.innerHTML += `<button class="webhook-tab" data-tab="${key}">${siteSettings.appConfigs[key].title}</button>`;
        });
        tabsContainer.innerHTML += `<button class="webhook-tab" data-tab="logs">Global Logs</button>`;
        document.querySelectorAll('.webhook-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === tabKey);
            tab.addEventListener('click', () => renderWebhookEditor(tab.dataset.tab));
        });

        const container = document.getElementById('webhook-editor-container');
        let html = '';

        if (tabKey === 'logs') {
            const config = siteSettings.logWebhooks;
            html = `<h3>Global Logging</h3>
                    <div><label>Site Visit Log URL</label><input type="text" data-key="visitUrl" value="${config.visitUrl || ''}"></div>
                    <div><label>Admin Activity Log URL</label><input type="text" data-key="adminLogUrl" value="${config.adminLogUrl || ''}"></div>`;
        } else {
            const config = siteSettings.appConfigs[tabKey];
            html = `<h3>${config.title} Settings</h3>
                    <div><label>Webhook URL</label><input type="text" data-key="webhookUrl" value="${config.webhookUrl}"></div>
                    <div><label>Bot Name</label><input type="text" data-key="username" value="${config.username}"></div>
                    <div><label>Bot Avatar URL</label><input type="text" data-key="avatarUrl" value="${config.avatarUrl}"></div>
                    <div><label>Embed Color</label><input type="color" data-key="embedColor" value="${config.embedColor}" style="padding:0; height:40px;"></div>
                    <div><label>Embed Title</label><input type="text" data-key="embedTitle" value="${config.embedTitle}"></div>`;
        }
        container.innerHTML = html;
        container.dataset.activeTab = tabKey;
        container.querySelectorAll('input').forEach(input => input.addEventListener('input', updateWebhookPreview));
        updateWebhookPreview();
    }

    function updateWebhookPreview() {
        const activeTab = document.getElementById('webhook-editor-container').dataset.activeTab;
        if (!activeTab || activeTab === 'logs' || !siteSettings.appConfigs[activeTab]) { 
            document.querySelector('.discord-preview-container').style.opacity = '0.5'; return; 
        }
        
        document.querySelector('.discord-preview-container').style.opacity = '1';
        const config = siteSettings.appConfigs[activeTab];
        const tempConfig = {};
        document.querySelectorAll(`#webhook-editor-container [data-key]`).forEach(input => tempConfig[input.dataset.key] = input.value);

        document.getElementById('preview-username').textContent = tempConfig.username || "Bot";
        document.getElementById('preview-avatar').src = tempConfig.avatarUrl || defaultSettings.appConfigs.support.avatarUrl;
        document.getElementById('preview-embed-title').textContent = (tempConfig.embedTitle || "").replace('{role}', config.title);
        document.getElementById('preview-embed').style.borderLeftColor = tempConfig.embedColor;
    }

    function saveAllSettings() {
        // Save currently open webhook tab
        const activeTab = document.getElementById('webhook-editor-container').dataset.activeTab;
        if (activeTab) {
            const inputs = document.querySelectorAll(`#webhook-editor-container [data-key]`);
            if(activeTab === 'logs') {
                inputs.forEach(input => siteSettings.logWebhooks[input.dataset.key] = input.value);
            } else if (siteSettings.appConfigs[activeTab]) {
                inputs.forEach(input => siteSettings.appConfigs[activeTab][input.dataset.key] = input.value);
            }
        }
        
        localStorage.setItem('gtpsAppSettingsV2', JSON.stringify(siteSettings));
        simpleWebhookSend(siteSettings.logWebhooks.adminLogUrl, { username: "Admin Logger", content: "âœ… Admin has saved all site settings." });
        alert('All settings saved!');
        loadDataFromStorage();
        setupHomepage();
    }

    function resetAllData() {
        if (confirm('Are you sure you want to reset ALL settings to default? This cannot be undone.')) {
            localStorage.removeItem('gtpsAppSettingsV2');
            location.reload();
        }
    }
    
    // --- Application Editor ---
    function setupApplicationEditorList() {
        const container = document.getElementById('editor-selection-buttons');
        container.innerHTML = '<h3>Select Application to Edit</h3>';
        Object.keys(siteSettings.appConfigs).forEach(key => {
            container.innerHTML += `<button class="btn btn-secondary" onclick="renderApplicationEditor('${key}')">Edit ${siteSettings.appConfigs[key].title}</button>`;
        });
        container.innerHTML += `<hr style="border-color: var(--border-color); margin: 20px 0;"><button class="btn btn-primary" onclick="addApplicationType()">+ Add New Application Type</button>`;
        cancelEdit();
    }

    function renderApplicationEditor(appKey) { 
        const data = siteSettings.appConfigs[appKey];
        const view = document.getElementById('application-editor-view');
        document.getElementById('editor-selection-buttons').style.display = 'none';
        
        let questionsHTML = data.questions.map(q => `
            <div class="editor-question-item">
                <input class="question-label-input" value="${q.label.replace(/"/g, '&quot;')}">
                <select class="question-type-select">
                    <option value="text" ${q.type === 'text' ? 'selected' : ''}>Text</option>
                    <option value="textarea" ${q.type === 'textarea' ? 'selected' : ''}>Textarea</option>
                </select>
                <button class="btn-danger" onclick="this.parentElement.remove()">X</button>
            </div>`).join('');

        view.innerHTML = `
            <h3>Editing: ${data.title}</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div><label>Title</label><input id="edit-title" value="${data.title.replace(/"/g, '&quot;')}"></div>
                <div><label>Description</label><input id="edit-desc" value="${data.desc.replace(/"/g, '&quot;')}"></div>
            </div>
            <div><label>Icon (SVG Code)</label><textarea id="edit-icon" rows="3">${data.icon}</textarea></div>
            <h4 style="margin-top: 2rem;">Questions</h4>
            <div id="question-editor-container">${questionsHTML}</div>
            <div style="display:flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="addQuestionToEditor()">+ Add Question</button>
                <button class="btn btn-primary" style="flex-grow: 1;" onclick="saveApplicationChanges('${appKey}')">Save Changes</button>
                <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
            </div>
            <hr style="border-color: var(--border-color); margin: 20px 0;">
            <button class="btn btn-danger" onclick="deleteApplication('${appKey}')">Delete This Application</button>
        `;
        view.style.display = 'block';
    }

    function addQuestionToEditor() { 
        const container = document.getElementById('question-editor-container');
        const newItem = document.createElement('div');
        newItem.className = 'editor-question-item';
        newItem.innerHTML = `
            <input class="question-label-input" placeholder="New Question Label">
            <select class="question-type-select">
                <option value="text">Text</option>
                <option value="textarea" selected>Textarea</option>
            </select>
            <button class="btn-danger" onclick="this.parentElement.remove()">X</button>
        `;
        container.appendChild(newItem);
    }

    function cancelEdit() { 
        document.getElementById('application-editor-view').style.display = 'none'; 
        document.getElementById('editor-selection-buttons').style.display = 'block'; 
    }

    function saveApplicationChanges(appKey) {
        const config = siteSettings.appConfigs[appKey];
        config.title = document.getElementById('edit-title').value;
        config.desc = document.getElementById('edit-desc').value;
        config.icon = document.getElementById('edit-icon').value;
        
        const questions = [];
        document.querySelectorAll('.editor-question-item').forEach((item, i) => {
            const label = item.querySelector('.question-label-input').value;
            const type = item.querySelector('.question-type-select').value;
            if (label) {
                questions.push({
                    label: label,
                    type: type,
                    id: `${appKey.substring(0,3)}-q${i}`
                });
            }
        });
        config.questions = questions;

        saveAllSettings();
        alert(`'${config.title}' application saved!`);
        setupApplicationEditorList();
    }

    function addApplicationType() {
        const key = prompt("Enter a unique short key for the new application (e.g., 'moderator', no spaces).");
        if (key && !siteSettings.appConfigs[key]) {
            siteSettings.appConfigs[key] = JSON.parse(JSON.stringify(defaultSettings.appConfigs.support)); // clone default
            siteSettings.appConfigs[key].title = "New Application";
            siteSettings.appConfigs[key].desc = "A new role to apply for.";
            siteSettings.appConfigs[key].questions = [{label: "Discord ID", type: "text"}];
            saveAllSettings();
            setupApplicationEditorList();
            renderApplicationEditor(key);
        } else if (key) {
            alert("Error: That key already exists.");
        }
    }

    function deleteApplication(appKey) {
        if (confirm(`Are you sure you want to permanently delete the '${siteSettings.appConfigs[appKey].title}' application?`)) {
            delete siteSettings.appConfigs[appKey];
            saveAllSettings();
            setupApplicationEditorList();
            setupAdminPanel(); // Re-render admin panel to update webhook tabs
        }
    }
    
    // --- Initial Load & Effects ---
    function createSnowflakes() {
        const container = document.getElementById('snow-container');
        for (let i = 0; i < 150; i++) {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            const size = Math.random() * 4 + 1;
            snowflake.style.width = `${size}px`;
            snowflake.style.height = `${size}px`;
            snowflake.style.left = `${Math.random() * 100}vw`;
            snowflake.style.animationName = 'fall';
            snowflake.style.animationDuration = `${Math.random() * 10 + 10}s`;
            snowflake.style.animationDelay = `${Math.random() * 10}s`;
            snowflake.style.animationTimingFunction = 'linear';
            snowflake.style.animationIterationCount = 'infinite';
            container.appendChild(snowflake);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        createSnowflakes();
        loadDataFromStorage();
        setupHomepage();
        // fetchGeoInfoAndLog(); // Uncomment if you have a visitor webhook
    });
    </script>
</body>
</html>
